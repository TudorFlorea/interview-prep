# Design News Feed Ranking

[â† Back to Problems](/system-design/problems/00-index.md)

---

## ğŸ¯ Problem Statement

Design a personalized news feed ranking system (like Facebook/Twitter feed) that uses machine learning to order content based on user engagement signals and relevance.

**Difficulty**: ğŸ”´ Hard (Tier 1)

---

## 1. Requirements Gathering

### Functional Requirements

1. **Generate personalized feed** - Tailored to each user
2. **Rank by relevance** - Not just chronological
3. **Real-time updates** - New content appears quickly
4. **Support content types** - Posts, ads, recommendations
5. **Explainability** - Why am I seeing this?
6. **Diversity** - Avoid filter bubbles

### Non-Functional Requirements

| Aspect | Requirement |
|--------|-------------|
| **Latency** | &lt; 200ms for feed |
| **Freshness** | New posts within 1 minute |
| **Personalization** | Per-user ranking |
| **Scale** | 1 billion users |
| **A/B Testing** | Support experiments |

---

## 2. Back of Envelope Calculations

```
Users:
- 1 billion users
- 100 million DAU
- Average: 500 followees per user

Feed Generation:
- 100M feed requests/day
- 1,000 requests/second average
- Peak: 10,000 requests/second

Candidates:
- 500 followees Ã— 10 recent posts = 5,000 candidates
- Rank down to 50 for initial feed

Model Inference:
- 5,000 candidates Ã— 10,000 requests/sec = 50M inferences/sec
- Need efficient model + caching
```

---

## 3. Core Entities

```sql
-- Posts (content items)
CREATE TABLE posts (
    post_id UUID PRIMARY KEY,
    author_id UUID NOT NULL,
    content TEXT,
    media_urls JSON,
    post_type ENUM('text', 'image', 'video', 'link'),
    created_at TIMESTAMP,
    
    INDEX idx_author_time (author_id, created_at DESC)
);

-- User features (for ML)
CREATE TABLE user_features (
    user_id UUID PRIMARY KEY,
    embedding VECTOR(128),  -- User interest embedding
    topic_affinities JSON,  -- {politics: 0.3, sports: 0.8}
    engagement_history JSON,
    last_active TIMESTAMP,
    updated_at TIMESTAMP
);

-- Post features (for ML)
CREATE TABLE post_features (
    post_id UUID PRIMARY KEY,
    embedding VECTOR(128),  -- Content embedding
    topics JSON,
    engagement_stats JSON,  -- {likes: 100, comments: 20}
    author_features JSON,
    quality_score FLOAT,
    updated_at TIMESTAMP
);

-- Engagement events (for training)
CREATE TABLE engagements (
    event_id UUID PRIMARY KEY,
    user_id UUID,
    post_id UUID,
    action ENUM('view', 'like', 'comment', 'share', 'hide', 'report'),
    dwell_time_ms INT,
    created_at TIMESTAMP,
    
    INDEX idx_user_time (user_id, created_at)
);
```

---

## 4. High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NEWS FEED RANKING ARCHITECTURE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                           â”‚    User     â”‚                                 â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                  â”‚                                        â”‚
â”‚                                  â–¼                                        â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                         â”‚  Feed Service   â”‚                              â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                  â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                        â”‚                        â”‚               â”‚
â”‚         â–¼                        â–¼                        â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Candidate  â”‚         â”‚   Ranking   â”‚         â”‚   Blending  â”‚        â”‚
â”‚  â”‚ Generation  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    Model    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  & Mixing   â”‚        â”‚
â”‚  â”‚             â”‚         â”‚             â”‚         â”‚             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                       â”‚                       â”‚                â”‚
â”‚         â”‚                       â”‚                       â–¼                â”‚
â”‚         â”‚                       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚                       â”‚              â”‚    Feed     â”‚          â”‚
â”‚         â”‚                       â”‚              â”‚   Response  â”‚          â”‚
â”‚         â”‚                       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                       â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚             â”‚         â”‚             â”‚                                â”‚
â”‚  â–¼             â–¼         â–¼             â–¼                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚ â”‚Postâ”‚      â”‚User â”‚   â”‚Featureâ”‚   â”‚  Model  â”‚                         â”‚
â”‚ â”‚Indexâ”‚     â”‚Graphâ”‚   â”‚ Store â”‚   â”‚ Serving â”‚                         â”‚
â”‚ â””â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Offline Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Engagement  â”‚â”€â”€â–¶â”‚   Feature   â”‚â”€â”€â–¶â”‚   Model     â”‚                  â”‚
â”‚  â”‚    Logs     â”‚   â”‚ Engineering â”‚   â”‚  Training   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Deep Dive: Candidate Generation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CANDIDATE GENERATION                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Goal: Reduce billions of posts to thousands of candidates    â”‚
â”‚                                                                 â”‚
â”‚  Sources:                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  1. Following Feed                                              â”‚
â”‚     â€¢ Posts from users you follow                              â”‚
â”‚     â€¢ Recent posts (last 24-48 hours)                         â”‚
â”‚                                                                 â”‚
â”‚  2. Friend-of-Friend                                            â”‚
â”‚     â€¢ Posts liked/shared by friends                           â”‚
â”‚     â€¢ Viral content from network                              â”‚
â”‚                                                                 â”‚
â”‚  3. Interest-based                                              â”‚
â”‚     â€¢ Posts matching user's topic interests                   â”‚
â”‚     â€¢ Similar to previously engaged content                   â”‚
â”‚                                                                 â”‚
â”‚  4. Trending                                                    â”‚
â”‚     â€¢ Globally or locally trending posts                      â”‚
â”‚                                                                 â”‚
â”‚  Retrieval Methods:                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  1. Fan-out on Read:                                   â”‚   â”‚
â”‚  â”‚     Query posts from each followee                     â”‚   â”‚
â”‚  â”‚     Merge and sort                                     â”‚   â”‚
â”‚  â”‚     O(followees Ã— posts_per_user)                     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  2. Embedding Similarity (ANN):                        â”‚   â”‚
â”‚  â”‚     user_embedding â†’ nearest post_embeddings           â”‚   â”‚
â”‚  â”‚     Using FAISS, ScaNN, or Milvus                     â”‚   â”‚
â”‚  â”‚     O(log N) approximate search                       â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  3. Inverted Index:                                    â”‚   â”‚
â”‚  â”‚     topic â†’ posts mapping                             â”‚   â”‚
â”‚  â”‚     User topics â†’ candidate posts                     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Candidate Pool:                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  â€¢ 1,000 - 10,000 candidates per user                         â”‚
â”‚  â€¢ Diverse sources to avoid echo chamber                      â”‚
â”‚  â€¢ Pre-filtered for relevance                                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Deep Dive: Ranking Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RANKING MODEL                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Multi-Objective Ranking:                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚  Predict multiple engagement types:                            â”‚
â”‚  â€¢ P(like | user, post)                                       â”‚
â”‚  â€¢ P(comment | user, post)                                    â”‚
â”‚  â€¢ P(share | user, post)                                      â”‚
â”‚  â€¢ P(dwell_time > 30s | user, post)                          â”‚
â”‚  â€¢ P(hide | user, post) - negative signal                     â”‚
â”‚                                                                 â”‚
â”‚  Final Score:                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  score = w1 Ã— P(like) + w2 Ã— P(comment) + w3 Ã— P(share)      â”‚
â”‚          + w4 Ã— P(dwell) - w5 Ã— P(hide)                       â”‚
â”‚                                                                 â”‚
â”‚  Features:                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  User Features:           Post Features:               â”‚   â”‚
â”‚  â”‚  â€¢ User embedding         â€¢ Post embedding             â”‚   â”‚
â”‚  â”‚  â€¢ Topic interests        â€¢ Topics                     â”‚   â”‚
â”‚  â”‚  â€¢ Activity level         â€¢ Post age                   â”‚   â”‚
â”‚  â”‚  â€¢ Friend count           â€¢ Engagement count           â”‚   â”‚
â”‚  â”‚  â€¢ Demographics           â€¢ Author quality score       â”‚   â”‚
â”‚  â”‚  â€¢ Device/context         â€¢ Media type                 â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  Cross Features:                                       â”‚   â”‚
â”‚  â”‚  â€¢ User-author affinity                               â”‚   â”‚
â”‚  â”‚  â€¢ User-topic match                                   â”‚   â”‚
â”‚  â”‚  â€¢ Historical engagement                              â”‚   â”‚
â”‚  â”‚  â€¢ Social connection strength                         â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Model Architecture:                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚  Two-Tower + Cross Network:                                    â”‚
â”‚                                                                 â”‚
â”‚  User Tower    Post Tower                                      â”‚
â”‚      â”‚             â”‚                                           â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚             â”‚                                                   â”‚
â”‚         Dot Product (for retrieval)                            â”‚
â”‚             â”‚                                                   â”‚
â”‚      Cross Network (for ranking)                               â”‚
â”‚             â”‚                                                   â”‚
â”‚         Final Score                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Feature Engineering

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FEATURE ENGINEERING                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Real-time Features:                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚  â€¢ Post age (seconds since creation)                          â”‚
â”‚  â€¢ Current engagement velocity                                 â”‚
â”‚  â€¢ User's recent activity                                      â”‚
â”‚  â€¢ Time of day                                                 â”‚
â”‚                                                                 â”‚
â”‚  Near-real-time (updated every minute):                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚
â”‚  â€¢ Post engagement counts                                      â”‚
â”‚  â€¢ Trending scores                                             â”‚
â”‚  â€¢ Author recent activity                                      â”‚
â”‚                                                                 â”‚
â”‚  Batch Features (updated daily):                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚  â€¢ User embeddings                                             â”‚
â”‚  â€¢ Topic affinities                                            â”‚
â”‚  â€¢ Long-term engagement patterns                               â”‚
â”‚                                                                 â”‚
â”‚  Feature Store:                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚  â”‚  â”‚   Batch     â”‚    â”‚  Streaming  â”‚                   â”‚   â”‚
â”‚  â”‚  â”‚   Pipeline  â”‚    â”‚  Pipeline   â”‚                   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚  â”‚         â”‚                  â”‚                           â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â”‚                  â–¼                                     â”‚   â”‚
â”‚  â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚   â”‚
â”‚  â”‚           â”‚   Feature   â”‚                             â”‚   â”‚
â”‚  â”‚           â”‚    Store    â”‚                             â”‚   â”‚
â”‚  â”‚           â”‚   (Redis)   â”‚                             â”‚   â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                             â”‚   â”‚
â”‚  â”‚                  â”‚                                     â”‚   â”‚
â”‚  â”‚                  â–¼                                     â”‚   â”‚
â”‚  â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚   â”‚
â”‚  â”‚           â”‚   Serving   â”‚                             â”‚   â”‚
â”‚  â”‚           â”‚    Layer    â”‚                             â”‚   â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Feed Diversity & Quality

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DIVERSITY & QUALITY                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Problem: Pure relevance ranking creates echo chambers         â”‚
â”‚                                                                 â”‚
â”‚  Diversity Techniques:                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚  1. MMR (Maximal Marginal Relevance)                           â”‚
â”‚     score = Î» Ã— relevance - (1-Î») Ã— max_similarity_to_selectedâ”‚
â”‚     Balances relevance with diversity                          â”‚
â”‚                                                                 â”‚
â”‚  2. Topic Quotas                                                â”‚
â”‚     â€¢ Max 30% from any single topic                           â”‚
â”‚     â€¢ Inject content from underrepresented topics             â”‚
â”‚                                                                 â”‚
â”‚  3. Source Diversity                                            â”‚
â”‚     â€¢ Limit posts from same author                            â”‚
â”‚     â€¢ Mix different content types                             â”‚
â”‚                                                                 â”‚
â”‚  Quality Signals:                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ Author credibility score                                    â”‚
â”‚  â€¢ Content quality classifier                                  â”‚
â”‚  â€¢ Engagement authenticity                                     â”‚
â”‚  â€¢ Misinformation detection                                    â”‚
â”‚                                                                 â”‚
â”‚  Blending Logic:                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  def blend_feed(ranked_posts, ads, recommendations):           â”‚
â”‚      feed = []                                                  â”‚
â”‚      for i, post in enumerate(ranked_posts):                  â”‚
â”‚          feed.append(post)                                     â”‚
â”‚          if i % 5 == 4:  # Every 5th position                 â”‚
â”‚              feed.append(ads.pop(0))                          â”‚
â”‚          if i % 10 == 9:  # Every 10th position              â”‚
â”‚              feed.append(recommendations.pop(0))              â”‚
â”‚      return feed                                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Model Training Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TRAINING PIPELINE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Training Data:                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  â€¢ (user, post, action, label) tuples                         â”‚
â”‚  â€¢ Positive: user engaged with post                           â”‚
â”‚  â€¢ Negative: user saw but didn't engage                       â”‚
â”‚                                                                 â”‚
â”‚  Negative Sampling:                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  â€¢ Random negatives (not seen)                                â”‚
â”‚  â€¢ Hard negatives (seen but ignored)                          â”‚
â”‚  â€¢ In-batch negatives (efficient)                             â”‚
â”‚                                                                 â”‚
â”‚  Pipeline:                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  Engagement Logs â†’ Feature Join â†’ Training Data        â”‚   â”‚
â”‚  â”‚         â”‚                              â”‚                â”‚   â”‚
â”‚  â”‚         â–¼                              â–¼                â”‚   â”‚
â”‚  â”‚    Label Events                  Feature Store         â”‚   â”‚
â”‚  â”‚         â”‚                              â”‚                â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                        â–¼                                â”‚   â”‚
â”‚  â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚                 â”‚   Train    â”‚                         â”‚   â”‚
â”‚  â”‚                 â”‚   Model    â”‚                         â”‚   â”‚
â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚  â”‚                       â”‚                                 â”‚   â”‚
â”‚  â”‚                       â–¼                                 â”‚   â”‚
â”‚  â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚                 â”‚  Evaluate  â”‚                         â”‚   â”‚
â”‚  â”‚                 â”‚   (A/B)    â”‚                         â”‚   â”‚
â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚  â”‚                       â”‚                                 â”‚   â”‚
â”‚  â”‚                       â–¼                                 â”‚   â”‚
â”‚  â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚                 â”‚   Deploy   â”‚                         â”‚   â”‚
â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Retraining:                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚  â€¢ Daily incremental updates                                   â”‚
â”‚  â€¢ Weekly full retraining                                      â”‚
â”‚  â€¢ A/B test before rollout                                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Technology Choices

| Component | Technology | Rationale |
|-----------|------------|-----------|
| Candidate Retrieval | FAISS/ScaNN | Fast ANN search |
| Feature Store | Redis/Feast | Low latency |
| Model Serving | TensorFlow Serving | Scalable inference |
| Training | PyTorch/TensorFlow | Flexible ML |
| A/B Testing | Custom | Statistical rigor |
| Stream Processing | Flink | Real-time features |

---

## 11. Key Takeaways

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   KEY TAKEAWAYS                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. TWO-STAGE RANKING                                           â”‚
â”‚     Candidate generation â†’ Ranking model                       â”‚
â”‚                                                                 â”‚
â”‚  2. MULTI-OBJECTIVE                                             â”‚
â”‚     Predict multiple engagement types                          â”‚
â”‚                                                                 â”‚
â”‚  3. FEATURE ENGINEERING                                         â”‚
â”‚     Real-time + batch features                                 â”‚
â”‚                                                                 â”‚
â”‚  4. DIVERSITY                                                   â”‚
â”‚     Avoid filter bubbles with MMR                              â”‚
â”‚                                                                 â”‚
â”‚  5. CONTINUOUS LEARNING                                         â”‚
â”‚     Retrain on fresh engagement data                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. References

- [05-caching.md](/system-design/fundamentals/07-caching.md) - Feature caching
- [09-message-queues.md](/system-design/fundamentals/09-message-queues.md) - Event streaming
- Batch Processing - ML pipelines

---

[â† Back to Problems](/system-design/problems/00-index.md) | [Next: Amazon Locker â†’](/system-design/problems/21-amazon-locker.md)
