# Distributed System Patterns

[â† Back to Fundamentals](/system-design/fundamentals/00-index.md)

---

## Overview

Distributed systems require special patterns to handle coordination, failure, and consistency across multiple nodes. This guide covers essential patterns including leader election, consensus, distributed transactions, and the saga pattern.

---

## ğŸ‘‘ Leader Election

### Why Leader Election?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LEADER ELECTION NEED                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Problem: Some tasks need a single coordinator                  â”‚
â”‚                                                                 â”‚
â”‚  Examples:                                                      â”‚
â”‚  - Database primary (one writer)                                â”‚
â”‚  - Cron job runner (run once, not N times)                      â”‚
â”‚  - Partition assignment (consistent decisions)                  â”‚
â”‚  - Lock management (one source of truth)                        â”‚
â”‚                                                                 â”‚
â”‚  Without leader:              With leader:                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”           â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                â”‚
â”‚  â”‚ A â”‚ â”‚ B â”‚ â”‚ C â”‚           â”‚ A â”‚ â”‚â˜…Bâ˜…â”‚ â”‚ C â”‚                â”‚
â”‚  â””â”€â”¬â”€â”˜ â””â”€â”¬â”€â”˜ â””â”€â”¬â”€â”˜           â””â”€â”¬â”€â”˜ â””â”€â”¬â”€â”˜ â””â”€â”¬â”€â”˜                â”‚
â”‚    â”‚     â”‚     â”‚               â”‚     â”‚     â”‚                   â”‚
â”‚    â–¼     â–¼     â–¼               â”‚     â–¼     â”‚                   â”‚
â”‚  Write Write Write             â””â”€â”€â”€â”€â–ºBâ—„â”€â”€â”€â”€â”˜                   â”‚
â”‚  (conflict!)                    (coordinated)                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Election Approaches

#### 1. Bully Algorithm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BULLY ALGORITHM                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Rule: Highest ID wins                                          â”‚
â”‚                                                                 â”‚
â”‚  Nodes: A(1), B(2), C(3) â€” C is leader                         â”‚
â”‚                                                                 â”‚
â”‚  C fails:                                                       â”‚
â”‚  1. B notices, sends ELECTION to higher IDs (C)                â”‚
â”‚  2. B gets no response (C is dead)                             â”‚
â”‚  3. B declares itself leader, sends COORDINATOR msg            â”‚
â”‚                                                                 â”‚
â”‚  C recovers:                                                    â”‚
â”‚  1. C sends ELECTION to higher IDs (none)                      â”‚
â”‚  2. C declares itself leader immediately                       â”‚
â”‚  3. C sends COORDINATOR to all                                 â”‚
â”‚                                                                 â”‚
â”‚  âœ… Simple to understand                                        â”‚
â”‚  âŒ Many messages                                               â”‚
â”‚  âŒ Assumes IDs are well-ordered                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. Using Zookeeper/etcd

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ZOOKEEPER LEADER ELECTION                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Each node creates ephemeral sequential znode:                  â”‚
â”‚                                                                 â”‚
â”‚  /election/                                                     â”‚
â”‚  â”œâ”€â”€ candidate_0000001  (Node A)                               â”‚
â”‚  â”œâ”€â”€ candidate_0000002  (Node B)                               â”‚
â”‚  â””â”€â”€ candidate_0000003  (Node C)                               â”‚
â”‚                                                                 â”‚
â”‚  Rule: Lowest sequence number is leader                         â”‚
â”‚                                                                 â”‚
â”‚  Leader (A) crashes:                                            â”‚
â”‚  1. Ephemeral node deleted automatically                        â”‚
â”‚  2. B watches its predecessor (was A)                          â”‚
â”‚  3. B notified A's node gone                                   â”‚
â”‚  4. B becomes leader (now lowest)                              â”‚
â”‚                                                                 â”‚
â”‚  âœ… Reliable (Zookeeper handles complexity)                     â”‚
â”‚  âœ… Automatic failover (ephemeral nodes)                        â”‚
â”‚  âœ… Watch mechanism (efficient notifications)                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. Using Database Locks

```sql
-- Simple leader election with database

-- Create election table
CREATE TABLE leader_election (
    lock_name VARCHAR(100) PRIMARY KEY,
    leader_id VARCHAR(100) NOT NULL,
    acquired_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL
);

-- Try to become leader (atomic)
INSERT INTO leader_election (lock_name, leader_id, acquired_at, expires_at)
VALUES ('scheduler', 'node-1', NOW(), NOW() + INTERVAL '30 seconds')
ON CONFLICT (lock_name) DO UPDATE
SET leader_id = EXCLUDED.leader_id,
    acquired_at = EXCLUDED.acquired_at,
    expires_at = EXCLUDED.expires_at
WHERE leader_election.expires_at < NOW();  -- Only if expired

-- Renew leadership (heartbeat)
UPDATE leader_election
SET expires_at = NOW() + INTERVAL '30 seconds'
WHERE lock_name = 'scheduler' AND leader_id = 'node-1';
```

---

## ğŸ¤ Consensus Algorithms

### The Consensus Problem

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONSENSUS PROBLEM                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Goal: All nodes agree on a single value/decision               â”‚
â”‚                                                                 â”‚
â”‚  Properties required:                                           â”‚
â”‚  1. Agreement: All non-faulty nodes decide same value           â”‚
â”‚  2. Validity: The decided value was proposed by some node       â”‚
â”‚  3. Termination: All non-faulty nodes eventually decide         â”‚
â”‚                                                                 â”‚
â”‚  Challenges:                                                    â”‚
â”‚  - Nodes can crash                                              â”‚
â”‚  - Messages can be lost/delayed                                 â”‚
â”‚  - Network can partition                                        â”‚
â”‚                                                                 â”‚
â”‚  Used for:                                                      â”‚
â”‚  - Leader election                                              â”‚
â”‚  - Distributed locks                                            â”‚
â”‚  - Replicated state machines                                    â”‚
â”‚  - Transaction commit                                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Raft Consensus

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAFT OVERVIEW                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Three roles:                                                   â”‚
â”‚  - Leader: Handles all client requests                         â”‚
â”‚  - Follower: Replicates leader's log                           â”‚
â”‚  - Candidate: Trying to become leader                           â”‚
â”‚                                                                 â”‚
â”‚  Normal Operation:                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚            Client                                               â”‚
â”‚               â”‚                                                 â”‚
â”‚               â–¼                                                 â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚          â”‚ Leader â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚                 â”‚
â”‚               â”‚                               â”‚                 â”‚
â”‚          Replicate                       Replicate              â”‚
â”‚               â”‚                               â”‚                 â”‚
â”‚               â–¼                               â–¼                 â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚          â”‚ Follower â”‚                   â”‚ Follower â”‚           â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  1. Client sends request to leader                              â”‚
â”‚  2. Leader appends to log                                       â”‚
â”‚  3. Leader replicates to followers                              â”‚
â”‚  4. Majority ack â†’ committed                                    â”‚
â”‚  5. Leader responds to client                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Raft Leader Election

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAFT ELECTION                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. Follower times out (no heartbeat from leader)               â”‚
â”‚  2. Follower becomes Candidate                                  â”‚
â”‚  3. Candidate increments term, votes for self                   â”‚
â”‚  4. Candidate requests votes from all nodes                     â”‚
â”‚  5. Nodes vote (one vote per term)                              â”‚
â”‚  6. Majority votes â†’ Candidate becomes Leader                   â”‚
â”‚                                                                 â”‚
â”‚  Timeline:                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                  â”‚
â”‚                                                                 â”‚
â”‚  Term 1:  [â”€â”€â”€â”€â”€â”€â”€ Leader A â”€â”€â”€â”€â”€â”€â”€]                            â”‚
â”‚                                    â”‚                            â”‚
â”‚                                    A crashes                    â”‚
â”‚                                    â”‚                            â”‚
â”‚  Term 2:  [Election timeout]â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
â”‚           B: RequestVote(term=2)   â”‚                            â”‚
â”‚           C: Vote for B            â”‚                            â”‚
â”‚           B wins!                  â”‚                            â”‚
â”‚  Term 2:           [â”€â”€â”€â”€â”€â”€ Leader B â”€â”€â”€â”€â”€â”€]                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Paxos (Brief Overview)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PAXOS PHASES                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Phase 1: Prepare                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  Proposer â†’ Acceptors: "I want to propose (n)"                  â”‚
â”‚  Acceptors â†’ Proposer: "OK, here's highest I've seen"           â”‚
â”‚                                                                 â”‚
â”‚  Phase 2: Accept                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  Proposer â†’ Acceptors: "Accept value V with proposal n"         â”‚
â”‚  Acceptors â†’ Proposer: "Accepted" (if n still highest)          â”‚
â”‚                                                                 â”‚
â”‚  Majority accepts â†’ Value chosen!                               â”‚
â”‚                                                                 â”‚
â”‚  Paxos vs Raft:                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚  Paxos: More theoretical, harder to understand                  â”‚
â”‚  Raft: Designed for understandability, same guarantees          â”‚
â”‚                                                                 â”‚
â”‚  In practice: Use Raft or existing implementations              â”‚
â”‚  (etcd, Consul, CockroachDB all use Raft)                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° Distributed Transactions

### Two-Phase Commit (2PC)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TWO-PHASE COMMIT                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Phase 1: Prepare (Voting)                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚                                                                 â”‚
â”‚       Coordinator                                               â”‚
â”‚           â”‚                                                     â”‚
â”‚       Prepare?â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚           â”‚           â”‚           â”‚                             â”‚
â”‚           â–¼           â–¼           â–¼                             â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚       â”‚Node A â”‚   â”‚Node B â”‚   â”‚Node C â”‚                        â”‚
â”‚       â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜                        â”‚
â”‚           â”‚           â”‚           â”‚                             â”‚
â”‚         Yes         Yes         Yes                             â”‚
â”‚           â”‚           â”‚           â”‚                             â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                       â–¼                                         â”‚
â”‚                 All voted Yes!                                  â”‚
â”‚                                                                 â”‚
â”‚  Phase 2: Commit (Decision)                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â”‚
â”‚                                                                 â”‚
â”‚       Coordinator                                               â”‚
â”‚           â”‚                                                     â”‚
â”‚       COMMITâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚           â”‚           â”‚           â”‚                             â”‚
â”‚           â–¼           â–¼           â–¼                             â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚       â”‚Node A â”‚   â”‚Node B â”‚   â”‚Node C â”‚                        â”‚
â”‚       â”‚COMMIT â”‚   â”‚COMMIT â”‚   â”‚COMMIT â”‚                        â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2PC Problems

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    2PC BLOCKING PROBLEM                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Scenario: Coordinator crashes after sending Prepare            â”‚
â”‚                                                                 â”‚
â”‚       Coordinator âœ—                                             â”‚
â”‚           â”‚                                                     â”‚
â”‚       Prepare?â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚           â”‚           â”‚                                         â”‚
â”‚           âœ—           â–¼                                         â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                   â”‚Node A â”‚  "I voted Yes..."                   â”‚
â”‚                   â”‚Locked!â”‚  "Do I commit or abort?"            â”‚
â”‚                   â”‚  ???  â”‚  "Coordinator is dead!"             â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                 â”‚
â”‚  Node A is BLOCKED:                                             â”‚
â”‚  - Can't commit (no decision received)                          â”‚
â”‚  - Can't abort (maybe others committed)                         â”‚
â”‚  - Must hold locks until coordinator recovers                   â”‚
â”‚                                                                 â”‚
â”‚  This is why 2PC is rarely used in practice for                 â”‚
â”‚  systems requiring high availability                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Three-Phase Commit (3PC)

```
Adds a Pre-Commit phase to avoid blocking:

Phase 1: Prepare    â†’ Participants vote
Phase 2: Pre-Commit â†’ Coordinator broadcasts intent  
Phase 3: Commit     â†’ Actual commit

If coordinator dies after Pre-Commit, participants
can coordinate among themselves to complete.

Still not commonly used due to complexity.
Better: Use Saga pattern or avoid distributed transactions.
```

---

## ğŸ­ Saga Pattern

### Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SAGA PATTERN                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Alternative to distributed transactions                        â”‚
â”‚  Break transaction into local transactions + compensations      â”‚
â”‚                                                                 â”‚
â”‚  Example: Book a trip (flight + hotel + car)                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚                                                                 â”‚
â”‚  Forward transactions:                                          â”‚
â”‚  T1: Book flight                                                â”‚
â”‚  T2: Book hotel                                                 â”‚
â”‚  T3: Book car                                                   â”‚
â”‚                                                                 â”‚
â”‚  Compensating transactions (undo):                              â”‚
â”‚  C1: Cancel flight                                              â”‚
â”‚  C2: Cancel hotel                                               â”‚
â”‚  C3: Cancel car                                                 â”‚
â”‚                                                                 â”‚
â”‚  If T3 fails:                                                   â”‚
â”‚  Execute C2, then C1 (reverse order)                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Saga Execution Patterns

#### Choreography (Event-Driven)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHOREOGRAPHY SAGA                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Each service listens for events and triggers next step         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     FlightBooked     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Flight    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚    Hotel    â”‚          â”‚
â”‚  â”‚   Service   â”‚                      â”‚   Service   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â–²                                     â”‚                  â”‚
â”‚        â”‚                              HotelBooked               â”‚
â”‚  OrderCreated                                â”‚                  â”‚
â”‚        â”‚                                     â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Order     â”‚                      â”‚     Car     â”‚          â”‚
â”‚  â”‚   Service   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   Service   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     SagaComplete     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â”‚  âœ… Loose coupling                                              â”‚
â”‚  âœ… Simple for small sagas                                      â”‚
â”‚  âŒ Hard to understand flow                                     â”‚
â”‚  âŒ Cyclic dependencies possible                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Orchestration (Centralized)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ORCHESTRATION SAGA                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Central orchestrator controls the saga                         â”‚
â”‚                                                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                    â”‚ Orchestrator â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                           â”‚                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚                 â”‚                 â”‚                   â”‚
â”‚         â–¼                 â–¼                 â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Flight    â”‚   â”‚    Hotel    â”‚   â”‚     Car     â”‚           â”‚
â”‚  â”‚   Service   â”‚   â”‚   Service   â”‚   â”‚   Service   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  Orchestrator:                                                  â”‚
â”‚  1. Call Flight.Book()                                          â”‚
â”‚  2. If success â†’ Call Hotel.Book()                              â”‚
â”‚  3. If success â†’ Call Car.Book()                                â”‚
â”‚  4. If any fails â†’ Call compensations                           â”‚
â”‚                                                                 â”‚
â”‚  âœ… Clear flow, easy to understand                              â”‚
â”‚  âœ… Easy to add/modify steps                                    â”‚
â”‚  âŒ Orchestrator can be bottleneck                              â”‚
â”‚  âŒ Tighter coupling to orchestrator                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Saga State Machine

```csharp
public class BookTripSaga
{
    private SagaState _state = SagaState.Started;
    private string _flightId;
    private string _hotelId;
    private string _carId;
    
    public async Task Execute()
    {
        try
        {
            // Step 1: Book Flight
            _state = SagaState.BookingFlight;
            _flightId = await _flightService.Book(request);
            
            // Step 2: Book Hotel
            _state = SagaState.BookingHotel;
            _hotelId = await _hotelService.Book(request);
            
            // Step 3: Book Car
            _state = SagaState.BookingCar;
            _carId = await _carService.Book(request);
            
            _state = SagaState.Completed;
        }
        catch (Exception ex)
        {
            await Compensate();
        }
    }
    
    private async Task Compensate()
    {
        _state = SagaState.Compensating;
        
        // Reverse order!
        if (_carId != null)
            await _carService.Cancel(_carId);
            
        if (_hotelId != null)
            await _hotelService.Cancel(_hotelId);
            
        if (_flightId != null)
            await _flightService.Cancel(_flightId);
            
        _state = SagaState.Compensated;
    }
}
```

---

## ğŸ”Œ Circuit Breaker Pattern

### The Problem

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CASCADING FAILURE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Service B is slow/failing:                                     â”‚
â”‚                                                                 â”‚
â”‚  Service A â”€â”€reqâ”€â”€â–º Service B (slow)                            â”‚
â”‚     â”‚                  â”‚                                        â”‚
â”‚     â”‚ threads         waiting...                                â”‚
â”‚     â”‚ waiting         waiting...                                â”‚
â”‚     â”‚                  â”‚                                        â”‚
â”‚     â–¼                  â–¼                                        â”‚
â”‚  A's thread pool     Eventually timeout                         â”‚
â”‚  exhausted!                                                     â”‚
â”‚                                                                 â”‚
â”‚  Now A can't handle ANY requests                                â”‚
â”‚  Failure cascades to A's callers!                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Circuit Breaker States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CIRCUIT BREAKER STATES                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚        Success                    Failure threshold             â”‚
â”‚           â”‚                             â”‚                       â”‚
â”‚           â–¼                             â–¼                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚      â”‚ CLOSED  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    OPEN     â”‚                  â”‚
â”‚      â”‚         â”‚  Too many    â”‚             â”‚                  â”‚
â”‚      â”‚(normal) â”‚  failures    â”‚(fail fast)  â”‚                  â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚           â–²                          â”‚                          â”‚
â”‚           â”‚                      Timeout                        â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â”‚                          â–¼                          â”‚
â”‚           â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚           â”‚                   â”‚  HALF-OPEN  â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚                  â”‚
â”‚                Success        â”‚ (testing)   â”‚                  â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                      â”‚                          â”‚
â”‚                                   Failure                       â”‚
â”‚                                      â”‚                          â”‚
â”‚                                      â–¼                          â”‚
â”‚                                    OPEN                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation

```csharp
public class CircuitBreaker
{
    private State _state = State.Closed;
    private int _failureCount = 0;
    private DateTime _openedAt;
    
    private const int FailureThreshold = 5;
    private const int TimeoutSeconds = 30;
    
    public async Task<T> Execute<T>(Func<Task<T>> action)
    {
        if (_state == State.Open)
        {
            if (DateTime.UtcNow - _openedAt > TimeSpan.FromSeconds(TimeoutSeconds))
            {
                _state = State.HalfOpen;
            }
            else
            {
                throw new CircuitOpenException("Circuit is open");
            }
        }
        
        try
        {
            var result = await action();
            OnSuccess();
            return result;
        }
        catch (Exception)
        {
            OnFailure();
            throw;
        }
    }
    
    private void OnSuccess()
    {
        _failureCount = 0;
        _state = State.Closed;
    }
    
    private void OnFailure()
    {
        _failureCount++;
        if (_failureCount >= FailureThreshold)
        {
            _state = State.Open;
            _openedAt = DateTime.UtcNow;
        }
    }
}
```

---

## ğŸ” Retry Patterns

### Exponential Backoff

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXPONENTIAL BACKOFF                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Attempt 1: Wait 1 second                                       â”‚
â”‚  Attempt 2: Wait 2 seconds                                      â”‚
â”‚  Attempt 3: Wait 4 seconds                                      â”‚
â”‚  Attempt 4: Wait 8 seconds                                      â”‚
â”‚  Attempt 5: Wait 16 seconds (or max)                            â”‚
â”‚                                                                 â”‚
â”‚  With jitter (randomization):                                   â”‚
â”‚  Wait = min(cap, base * 2^attempt) + random(0, 1000ms)          â”‚
â”‚                                                                 â”‚
â”‚  Why jitter? Prevent thundering herd:                           â”‚
â”‚  Without jitter: 1000 clients all retry at exactly 2 seconds    â”‚
â”‚  With jitter: Clients spread out their retries                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Retry Implementation

```csharp
public async Task<T> RetryWithBackoff<T>(
    Func<Task<T>> action,
    int maxRetries = 3,
    int baseDelayMs = 1000)
{
    var attempt = 0;
    
    while (true)
    {
        try
        {
            return await action();
        }
        catch (Exception ex) when (IsTransient(ex) && attempt < maxRetries)
        {
            attempt++;
            
            // Exponential backoff with jitter
            var delay = Math.Min(30000, baseDelayMs * Math.Pow(2, attempt));
            var jitter = Random.Shared.Next(0, 1000);
            
            await Task.Delay((int)delay + jitter);
        }
    }
}

private bool IsTransient(Exception ex)
{
    return ex is TimeoutException 
        || ex is HttpRequestException
        || (ex is HttpResponseException hre && hre.StatusCode >= 500);
}
```

---

## ğŸ¯ Idempotency

### Why Idempotency Matters

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IDEMPOTENCY NEED                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Network is unreliable. Requests can be:                        â”‚
â”‚  - Lost                                                         â”‚
â”‚  - Duplicated                                                   â”‚
â”‚  - Received but response lost                                   â”‚
â”‚                                                                 â”‚
â”‚  Without idempotency:                                           â”‚
â”‚  Client: Pay $100                                               â”‚
â”‚  Server: Deducts $100, sends OK                                 â”‚
â”‚  Network: Loses response                                        â”‚
â”‚  Client: Timeout! Retry: Pay $100                               â”‚
â”‚  Server: Deducts $100 again!                                    â”‚
â”‚  Result: Customer charged $200                                  â”‚
â”‚                                                                 â”‚
â”‚  With idempotency:                                              â”‚
â”‚  Client: Pay $100 (idempotency_key=abc123)                      â”‚
â”‚  Server: Deducts $100, stores key, sends OK                     â”‚
â”‚  Network: Loses response                                        â”‚
â”‚  Client: Retry: Pay $100 (idempotency_key=abc123)               â”‚
â”‚  Server: Sees key already used, returns cached response         â”‚
â”‚  Result: Customer charged $100 correctly                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementing Idempotency

```csharp
public class PaymentService
{
    public async Task<PaymentResult> ProcessPayment(PaymentRequest request)
    {
        // Check if we've seen this request before
        var existingResult = await _cache.GetAsync($"payment:{request.IdempotencyKey}");
        if (existingResult != null)
        {
            return existingResult;  // Return cached result
        }
        
        // Use database transaction with unique constraint
        try
        {
            await using var transaction = await _db.BeginTransactionAsync();
            
            // Insert idempotency record (fails if duplicate)
            await _db.InsertAsync(new IdempotencyRecord
            {
                Key = request.IdempotencyKey,
                CreatedAt = DateTime.UtcNow
            });
            
            // Process payment
            var result = await ProcessPaymentInternal(request);
            
            // Store result for future lookups
            await _cache.SetAsync(
                $"payment:{request.IdempotencyKey}",
                result,
                TimeSpan.FromHours(24)
            );
            
            await transaction.CommitAsync();
            return result;
        }
        catch (UniqueConstraintException)
        {
            // Duplicate request - return cached or in-progress
            return await WaitForResult(request.IdempotencyKey);
        }
    }
}
```

---

## âœ… Key Takeaways

1. **Leader election** - Use Zookeeper/etcd, don't build your own
2. **Consensus is hard** - Use Raft implementations (etcd, Consul)
3. **Avoid 2PC** - Use Saga pattern for distributed transactions
4. **Saga compensations** - Design every action with an undo
5. **Circuit breakers** - Prevent cascading failures
6. **Always retry with backoff** - And add jitter!
7. **Make operations idempotent** - Use idempotency keys

---

## ğŸ“š Related Topics

- [CAP Theorem](/system-design/fundamentals/13-cap-theorem.md) - Consistency trade-offs
- [Message Queues](/system-design/fundamentals/09-message-queues.md) - Async communication
- [Fault Tolerance](/system-design/fundamentals/20-fault-tolerance.md) - Handling failures
- [Databases](/system-design/fundamentals/06-databases.md) - Transaction fundamentals
